<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kpet.mapper.OrderMapper">

	<select id="directOrderInfo" resultType="com.kpet.domain.OrderInfoVO">
	
		SELECT 
			pro_num,
			pro_name, 
			pro_img, 
			pro_uploadpath,
			pro_discount,
			pro_discount * #{ord_amount} as orderprice
		FROM 
			product_tbl
		WHERE 
			pro_num = #{pro_num}
	
	</select>
	
	   <!-- 장바구니 체크 주문하기 -->
      <select id="checkOrderInfo" resultType="com.kpet.domain.OrderInfoVO">
        SELECT 
           c.cart_code,
         p.pro_num,
         p.pro_name, 
         p.pro_img, 
         p.pro_uploadpath,
         c.cart_amount,
         p.pro_discount, 
         p.pro_discount * c.cart_amount as orderprice
      FROM 
         cart_tbl c inner join product_tbl p
      ON 
         c.pro_num = p.pro_num
      AND 
         c.user_id = #{user_id}
        AND 
           c.cart_code = #{cart_code}
 
   </select>
	
	<insert id="orderInsert" parameterType="com.kpet.domain.OrderVO">
		<selectKey keyProperty="ord_code" order="BEFORE" resultType="Integer">
			SELECT 
				seq_order_code.nextval 
			FROM 
				dual
		</selectKey>
		
		INSERT INTO 
			order_tbl
			(
				ord_code, 
        		user_id, 
        		ord_name, 
        		ord_postcode, 
        		ord_addr_basic, 
        		ord_addr_detail,
        		ord_phone,
        		ord_price,  
        		ord_depositor,
        		ord_message,
        		ord_state
			)
		VALUES
			(
				#{ord_code},
				#{user_id},
				#{ord_name},
				#{ord_postcode},
				#{ord_addr_basic},
				#{ord_addr_detail},
				#{ord_phone},
				#{ord_price},
				#{ord_depositor},
				#{ord_message},
				#{ord_state}
			)
	
	</insert>
	
	<insert id="orderDetailInsert" parameterType="com.kpet.domain.DetailOrder">
				
		INSERT INTO 
			detail_ord_tbl
			(
				ord_code, 
				pro_num, 
				dt_ord_amount, 
				dt_ord_price
			)
		VALUES
			(
				#{ord_code},
				#{pro_num},
				#{dt_ord_amount},
				#{dt_ord_price}				
			)
	
	</insert>

	<select id="getTotalCount" resultType="int">
			SELECT 
				count(*) 
			FROM 
				order_tbl 
			WHERE
				user_id = #{user_id}
	</select>
	
	<select id="userOrderListInfo" resultType="com.kpet.domain.UserOrderListInfo">

	SELECT
		o.ord_code, 
		d.pro_num, 
		p.pro_name,
		d.dt_ord_amount, 
		d.dt_ord_price,
		p.pro_uploadpath, 
		p.pro_img,
		o.ord_state,
        o.ord_regdate,
        o.ord_price,
        o.ord_name
	FROM 
		order_tbl o
	JOIN 
		detail_ord_tbl d
  	ON 
  		o.ord_code = d.ord_code
	JOIN 
		product_tbl p
  	ON 
  		d.pro_num = p.pro_num
	WHERE 
		o.user_id = #{user_id}
	ORDER BY 
		o.ord_code DESC
	</select>
	
	<select id="userOrderListPaging" resultType="com.kpet.domain.OrderVO">
		<![CDATA[
		    SELECT 
	                rn,
		            ord_code,
		            ord_name,
	                ord_price,
	                ord_state,
	                ord_regdate
		    FROM (
		        SELECT 
		            /*+ index_desc(order_tbl pk_order_tbl) */
	                rownum rn,
		            ord_code,
		            ord_name,
	                ord_price,
	                ord_state,
	                ord_regdate
		        FROM 
		            order_tbl
		        WHERE 
		            user_id = #{user_id} 
	        and
		        rownum <= (#{cri.pageNum} * #{cri.amount})
		) 
		WHERE 
		    rn > ((#{cri.pageNum} - 1) * #{cri.amount})
      	]]>
	</select>
	
	<!-- 고객 주문 상태 건수 -->
	<select id="ordStateCount" resultType="int">
	
		SELECT 
			COUNT(*)
		FROM 
			order_tbl
		WHERE 
			user_id = #{user_id}
		AND 
			ord_state = #{ord_state}
	    AND 
	        ord_regdate >= #{threeMonthsDate}
	</select>
</mapper>  